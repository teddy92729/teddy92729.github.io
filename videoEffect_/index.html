<!DOCTYPE html>
<html>

<head>
</head>

<body>
    <video src="//vjs.zencdn.net/v/oceans.mp4" id="v1" crossOrigin="anonymous" controls loop autoplay></video>
    <video id="v2"></video>
</body>
<script>
    class VideoEffect_TransformStream {
        constructor(srcVideoElement, destVideoElement, videoEditer) {
            if (!(srcVideoElement instanceof HTMLVideoElement)) throw new Error("invalid srcVideoElement");
            if (!(destVideoElement instanceof HTMLVideoElement)) throw new Error("invalid destVideoElement");

            srcVideoElement.addEventListener("play", () => {
                const videoStream = srcVideoElement.captureStream();
                const videoTrack = videoStream.getVideoTracks()[0];
                const trackProcessor = new MediaStreamTrackProcessor({ track: videoTrack });
                const trackGenerator = new MediaStreamTrackGenerator({ kind: "video" });
                const transformer = new TransformStream({
                    async transform(videoFrame, controller) {
                        videoEditer?.(videoFrame);
                        // setTimeout(() => videoFrame.close(), 1000);
                        controller.enqueue(videoFrame);
                    },
                });
                trackProcessor.readable
                    .pipeThrough(transformer)
                    .pipeTo(trackGenerator.writable);

                destVideoElement.srcObject = new MediaStream([trackGenerator]);
                destVideoElement.play().then(() => {
                    destVideoElement.addEventListener("pause", () => {
                        srcVideoElement.pause();
                    });
                    destVideoElement.addEventListener("play", () => {
                        srcVideoElement.play();
                    });
                    destVideoElement.addEventListener("seeked", () => {
                        srcVideoElement.currentTime = destVideoElement.currentTime;
                    });
                });
            })
        }
    };
    let v1 = document.getElementById("v1");
    let v2 = document.getElementById("v2");
    let pipe = new VideoEffect_TransformStream(v1, v2, (frame) => {

    });
</script>

</html>
