<!DOCTYPE html>
<html>

<head>
</head>

<body>
    <video src="//vjs.zencdn.net/v/oceans.mp4" id="v1" crossOrigin="anonymous" controls loop autoplay></video>
    <video id="v2"></video>
</body>
<script>
    class VideoEffect_TransformStream {
        constructor(srcVideoElement, videoEditer, destVideoElement) {
            if (!(srcVideoElement instanceof HTMLVideoElement)) throw new Error("invalid srcVideoElement");
            if (!(destVideoElement instanceof HTMLVideoElement)) throw new Error("invalid destVideoElement");
            if (!(videoEditer instanceof TransformStream)) throw new Error("invalid transformer");

            srcVideoElement.addEventListener("play", () => {
                const videoStream = srcVideoElement.captureStream();
                const videoTrack = videoStream.getVideoTracks()[0];
                const trackProcessor = new MediaStreamTrackProcessor({ track: videoTrack });
                const trackGenerator = new MediaStreamTrackGenerator({ kind: "video" });
                const transformer = new TransformStream({
                    async transform(videoFrame, controller) {
                        videoEditer?.(videoFrame);
                        // videoFrame.close();
                        controller.enqueue(videoFrame);
                    },
                });

                destVideoElement.srcObject = new MediaStream([trackGenerator]);
                destVideoElement.play();
                trackProcessor.readable
                    .pipeThrough(transformer)
                    .pipeTo(trackGenerator.writable);
            })
        }
    };
    let v1 = document.getElementById("v1");
    let v2 = document.getElementById("v2");
    let pipe = new VideoEffect_TransformStream(v1, () => { }, v2);
</script>

</html>
